

# Missing values

In this chapter, we discuss the pattern of missing values in our datasets. After carefully observing our data, we found out that data1, data2, data2.1, data3 do not have a lot of missing data. Even though they do, the missing pattern is pretty neat. Take data3 as an example, all the data from 1990 to 1997 are missing for indicators except from visitor arrivals. Therefore, we applied a heatmap for each of these datasets to show the missing patterns of the four datasets:

```{r}
# from chapter 2&3
data1.0 <- read.csv("1 visitor trend-不分state.csv")[-c(7:11),]
data2.0 <- read.csv("2 visitor trend-分state.csv")[-c(301:305),]
data2.10<- read.csv("2.1 visitor trend- state plus dest.csv")[-c(1051:1054),]
data3.0 <- read.csv("3 destination.csv")[-c(29:32),]
data4.0 <- read.csv("4 Q2主要数据.csv")[-c(217:221),]

library(tidyverse)
library(dplyr)

empty_as_na <- function(x){
    if("factor" %in% class(x)) x <- as.character(x) ## since ifelse wont work with factors
    #ifelse(as.character(x)!="", x, NA)
    ifelse(x!="", x, NA)
}


data1<- data1.0 %>% 
  mutate_each(funs(empty_as_na)) %>%
  pivot_longer(cols = -c("Market", "Indicator", "Units", "Destination"),
               names_to = "Year",
               values_to = "number")  %>%
  mutate(Year = substr(Year, 2, 1000)) %>%
  pivot_wider(names_from = "Year",
              values_from = "number")

data2<- data2.0 %>% 
  mutate_each(funs(empty_as_na)) %>%
  pivot_longer(cols = -c("Market", "Indicator", "Units", "Destination"),
               names_to = "Year",
               values_to = "number")  %>%
  mutate(Year = substr(Year, 2, 1000)) %>%
  pivot_wider(names_from = "Year",
              values_from = "number")

data2.1<- data2.10 %>% 
  mutate_each(funs(empty_as_na)) %>%
  pivot_longer(cols = -c("Market", "Indicator", "Units", "Destination"),
               names_to = "Year",
               values_to = "number")  %>%
  mutate(Year = substr(Year, 2, 1000)) %>%
  pivot_wider(names_from = "Year",
              values_from = "number")


data3<- data3.0 %>% 
  mutate_each(funs(empty_as_na)) %>%
  pivot_longer(cols = -c("Market", "Indicator", "Units", "Destination"),
               names_to = "Year",
               values_to = "number")  %>%
  mutate(Year = substr(Year, 2, 1000)) %>%
  pivot_wider(names_from = "Year",
              values_from = "number")


data4<- data4.0 %>%
  pivot_longer(cols = -c("Group", "Indicator", "Units"),
               names_to = "Year",
               values_to = "number")  %>%
  mutate(Year = substr(Year, 2, 1000)) %>%
  pivot_wider(names_from = "Year",
              values_from = "number")

d1<- tibble(data1[,-c(5:21)][,-c(3)][,c(1,2,3,8)])
d2<- tibble(data2[,-c(5:21)]) 
d2.1<- tibble(data2.1)[,-c(5:21)][,c(1,2,3,4,8)]
d4<- tibble(data4.0[,-c(4:19)][,c(1, 2, 8)])
```

```{r fig.width = 4, fig.height = 4}
empty_as_na <- function(x){
    if("factor" %in% class(x)) x <- as.character(x) ## since ifelse wont work with factors
    #ifelse(as.character(x)!="", x, NA)
    ifelse(x!="", x, NA)
}

missing1 <- data1 %>%
  rownames_to_column("id") %>%
  gather(key, value, -id) %>% 
  mutate(missing = ifelse(is.na(value), "yes", "no")) %>% 
  group_by(key) %>% 
  summarise(sum.na = sum(is.na(value)))

#ggplot(missing1, aes(x = key, y = sum.na)) +
#  geom_col(color = "blue", fill = "lightblue") +
#  #scale_x_continuous(breaks = 1:28, labels = missing$key) +
#  ggtitle("Number of missing values by day") +
#  xlab("") +
#  ylab("") +
#  theme(axis.text.x = element_text(angle = 90))

m1<- data1 %>%
  pivot_longer(cols = -c("Market", "Indicator", "Units", "Destination"),
               names_to = "Year",
               values_to = "number") %>%
  mutate(missing = ifelse(is.na(number), "yes", "no")) %>%
  ggplot(aes(x = Indicator, y = Year, fill = missing)) +
  geom_tile(color = "white") +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Missing values in data1")
```


```{r fig.width = 4, fig.height = 4}
missing2 <- data2 %>%
  rownames_to_column("id") %>%
  gather(key, value, -id) %>% 
  mutate(missing = ifelse(is.na(value), "yes", "no")) %>% 
  group_by(key) %>% 
  summarise(sum.na = sum(is.na(value)))

#ggplot(missing2, aes(x = key, y = sum.na)) +
#  geom_col(color = "blue", fill = "lightblue") +
#  #scale_x_continuous(breaks = 1:28, labels = missing$key) +
#  ggtitle("Number of missing values by day") +
#  xlab("") +
#  ylab("") +
#  theme(axis.text.x = element_text(angle = 90))

m2<- data2 %>%
  pivot_longer(cols = -c("Market", "Indicator", "Units", "Destination"),
               names_to = "Year",
               values_to = "number") %>%
  mutate(missing = ifelse(is.na(number), "yes", "no")) %>%
  ggplot(aes(x = Indicator, y = Year, fill = missing)) +
  geom_tile(color = "white") +
  labs(title = "Missing values in data2")
  #theme(axis.text.x = element_text(angle = 10))
```


```{r fig.width = 4, fig.height = 4}
missing2.1 <- data2.1 %>%
  rownames_to_column("id") %>%
  gather(key, value, -id) %>% 
  mutate(missing = ifelse(is.na(value), "yes", "no")) %>% 
  group_by(key) %>% 
  summarise(sum.na = sum(is.na(value)))

#ggplot(missing2.1, aes(x = key, y = sum.na)) +
#  geom_col(color = "blue", fill = "lightblue") +
#  #scale_x_continuous(breaks = 1:28, labels = missing$key) +
#  ggtitle("Number of missing values by day") +
#  xlab("") +
#  ylab("") +
#  theme(axis.text.x = element_text(angle = 90))

m2.1<- data2.1 %>%
  pivot_longer(cols = -c("Market", "Indicator", "Units", "Destination"),
               names_to = "Year",
               values_to = "number") %>%
  mutate(missing = ifelse(is.na(number), "yes", "no")) %>%
  ggplot(aes(x = Indicator, y = Year, fill = missing)) +
  geom_tile(color = "white") +
  labs(title = "Missing values in data2.1")#+
  #theme(axis.text.x = element_text(angle = 10))
```


```{r fig.width = 4, fig.height = 4}
missing3 <- data3 %>%
  rownames_to_column("id") %>%
  gather(key, value, -id) %>% 
  mutate(missing = ifelse(is.na(value), "yes", "no")) %>% 
  group_by(key) %>% 
  summarise(sum.na = sum(is.na(value)))

#ggplot(missing3, aes(x = key, y = sum.na)) +
#  geom_col(color = "blue", fill = "lightblue") +
#  #scale_x_continuous(breaks = 1:28, labels = missing$key) +
#  ggtitle("Number of missing values by day") +
#  xlab("") +
#  ylab("") +
#  theme(axis.text.x = element_text(angle = 90))

m3<- data3 %>%
  pivot_longer(cols = -c("Market", "Indicator", "Units", "Destination"),
               names_to = "Year",
               values_to = "number") %>%
  mutate(missing = ifelse(is.na(number), "yes", "no")) %>%
  ggplot(aes(x = Indicator, y = Year, fill = missing)) +
  geom_tile(color = "white") +
  theme(axis.text.x = element_text(angle = 10))+
  labs(title = "Missing values in data3")
```


```{r fig.width = 9, fig.height = 9}
#install.packages("ggpubr")
library(ggpubr)
ggarrange(m1, m2, m2.1, m3,  ncol = 2, nrow = 2)# + rremove("x.text"), 
          #labels = c("1", "2", "2.1", "3"),
          

```

From the plots we can see that data1 is only missing 8 values in Expenditure and PPPD (Per person per day spending) for 4 years. For data2, only average length of stay and visitor days in year 2021 is missing. For data2.1, the three indicators are all missing in 2021. For data3, all the data from 1990 to 1997 are missing for indicators except from visitor arrivals.

The story is pretty different for data4. Intuitively speaking, data4 has a lot of missing data in different indicators and different years. Therefore, we applied 3 different plots to present the pattern of missing values in data4:

```{r fig.width = 5, fig.height = 5}
tidy4<- data4 %>%
  rownames_to_column("id") %>%
  gather(key, value, -id) %>% 
  mutate(missing = ifelse(is.na(value), "yes", "no"))

missing4 <- tidy4 %>% 
    group_by(key) %>% 
    summarise(sum.na = sum(is.na(value)))

g4.1<- ggplot(missing4, aes(x = key, y = sum.na)) +
  geom_col(color = "blue", fill = "lightblue") +
  #scale_x_continuous(breaks = 1:28, labels = missing$key) +
  labs(title = "Missing values in data4, for different years",
       x = "Year",
       y = "number of missing values") +
  xlab("") +
  ylab("") +
  theme(axis.text.x = element_text(angle = 90))

```
```{r fig.width = 5, fig.height = 5}
#group missing
g4.3<- data4 %>%
  pivot_longer(cols = -c("Group", "Indicator", "Units"),
               names_to = "Year",
               values_to = "number") %>%
  mutate(missing = ifelse(is.na(number), "yes", "no")) %>%
  ggplot(aes(x = Group, y = Year, fill = missing)) +
  geom_tile(color = "white") +
  labs(title = "Missing values in data4, for different destinations",
       x = "destination") +
  theme(axis.text.x = element_text(angle = 90))
```

```{r fig.width = 10, fig.height = 5}
#install.packages("ggpubr")
library(ggpubr)
ggarrange(g4.1, g4.3, ncol = 2) # + rremove("x.text"), 
          #labels = c("1", "2", "2.1", "3"),
           #, nrow = 2)

```

From the histogram plot and the heatmap we can see that data for all destinations in 1999 to 2017 are greatly missing. And in the heatmap for missing data in different years and indicators shown below, we can see that the for year 2016 to 2020, no data is missing.

```{r fig.width = 7, fig.height = 7}
#indicator missing
data4 %>%
  pivot_longer(cols = -c("Group", "Indicator", "Units"),
               names_to = "Year",
               values_to = "number") %>%
  mutate(missing = ifelse(is.na(number), "yes", "no")) %>%
  ggplot(aes(x = Indicator, y = Year, fill = missing)) +
  geom_tile(color = "white") +
  ggtitle("Missing values in data4, for different years and indicators") +
  theme(axis.text.x = element_text(angle = 90))
```

In conclusion, the only years with no missing value at all should be 2018 and 2019. As the data in 2018 is too old, we chose to use the data in 2019 as our observation when analysing the first 2 problems. In problem 3 where we analyse the impact of pandemic on the tourism in Hawaii, we would use data in year 2018 to 2021.