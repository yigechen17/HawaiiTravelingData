
```{r setup, include=FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

# Results

From our analysis, we found out that most people come to Hawaii for vacation, and most of them would choose to come again. As for the Accommodation choice, people tend to rest in hotels and condos. For the destination, Oahu island and Maui island are the most popular ones, while people would spend similar time spending in Oahu, Maui, Kona and Kauai island. Lanai island seems to be the least popular island among all. We have also found that visitors from Illinois, Idaho, Georgia, Florida and some other southern states could have a clustering pattern when it comes to their destinations. The graphs and comments are shown below.


```{r}
# from chapter 2&3
data1.0 <- read.csv("1 visitor trend-不分state.csv")[-c(7:11),]
data2.0 <- read.csv("2 visitor trend-分state.csv")[-c(301:305),]
data2.10<- read.csv("2.1 visitor trend- state plus dest.csv")[-c(1051:1054),]
data3.0 <- read.csv("3 destination.csv")[-c(29:32),]
data4.0 <- read.csv("4 Q2主要数据.csv")[-c(217:221),]

library(tidyverse)
library(dplyr)

empty_as_na <- function(x){
    if("factor" %in% class(x)) x <- as.character(x) ## since ifelse wont work with factors
    #ifelse(as.character(x)!="", x, NA)
    ifelse(x!="", x, NA)
}


data1<- data1.0 %>% 
  mutate_each(funs(empty_as_na)) %>%
  pivot_longer(cols = -c("Market", "Indicator", "Units", "Destination"),
               names_to = "Year",
               values_to = "number")  %>%
  mutate(Year = substr(Year, 2, 1000)) %>%
  pivot_wider(names_from = "Year",
              values_from = "number")

data2<- data2.0 %>% 
  mutate_each(funs(empty_as_na)) %>%
  pivot_longer(cols = -c("Market", "Indicator", "Units", "Destination"),
               names_to = "Year",
               values_to = "number")  %>%
  mutate(Year = substr(Year, 2, 1000)) %>%
  pivot_wider(names_from = "Year",
              values_from = "number")

data2.1<- data2.10 %>% 
  mutate_each(funs(empty_as_na)) %>%
  pivot_longer(cols = -c("Market", "Indicator", "Units", "Destination"),
               names_to = "Year",
               values_to = "number")  %>%
  mutate(Year = substr(Year, 2, 1000)) %>%
  pivot_wider(names_from = "Year",
              values_from = "number")


data3<- data3.0 %>% 
  mutate_each(funs(empty_as_na)) %>%
  pivot_longer(cols = -c("Market", "Indicator", "Units", "Destination"),
               names_to = "Year",
               values_to = "number")  %>%
  mutate(Year = substr(Year, 2, 1000)) %>%
  pivot_wider(names_from = "Year",
              values_from = "number")


data4<- data4.0 %>%
  pivot_longer(cols = -c("Group", "Indicator", "Units"),
               names_to = "Year",
               values_to = "number")  %>%
  mutate(Year = substr(Year, 2, 1000)) %>%
  pivot_wider(names_from = "Year",
              values_from = "number")

d1<- tibble(data1[,-c(5:21)][,-c(3)][,c(1,2,3,8)])
d2<- tibble(data2[,-c(5:21)]) 
d2.1<- tibble(data2.1)[,-c(5:21)][,c(1,2,3,4,8)]
d4<- tibble(data4.0[,-c(4:19)][,c(1, 2, 8)])
```




## 1. What kind of people would come to Hawaii?

We analyse this question by exploring the average age of people who come to Hawaii, the percentage of people who come more than one time, and the Hawaii travel rate of the states.

```{r fig.width = 10, fig.height = 5}
d4.1<- d4 %>%
  filter(Group != "Visitor from US") %>%
  na.omit() %>%
  pivot_wider(names_from = Indicator, values_from = X2019) 
  
d4.1 %>%
  mutate(Group = factor(Group, levels = c("Oahu visitors", 
                                          "Maui visitors",
                                          "Hawaii ISL visitors",
                                          "Kauai visitors",
                                          "Lanai visitors",
                                          "Molokai visitors"))) %>%
  ggplot(aes(x = Group, y = `Avg. age of party head`)) +
  geom_col(fill = "cornflowerblue") +
  coord_flip() +
  labs(title = "Age distribution of people to different islands",
       x = "Average age",
       y = "Destination")


d4.1[,c(1,3,4)] %>%
  pivot_longer(c(`First timer (%)`, `Repeaters (%)`), 
               names_to ="Times of come", 
               values_to = "percentage") %>%
  ggplot(aes(x = Group, y = percentage, fill = `Times of come`)) +
  geom_col()  +
  labs(title = "Will people travel to Hawaii again? If they do, which island is more popular?",
       x = "Destination",
       y = "Percentage")
```

From the horizontal barchart we can see that the average age of people that come to Hawaii is 40 to 50 years old. Among all destinations, people who go to Molokai and Lanai are generally older, and people who go to Oahu and Maui island tend to be younger. Also, from the stacked barchart that shows how many visitors come to Hawaii for the first time and how many people have come several times, we can see that more than 60% of people are repeaters, which means that Hawaii is an attractive destination for people who are middle age, and they would always like to come again. Among all the islands in Hawaii, Maui and Kauai islands have the most repeaters, while Lanai island has the lest repeaters.


```{r}
# data cleaning example
rawdata2 = read.csv("data/raw/2 visitor trend-bystate.csv")
```

```{r,include=FALSE}
#tmap data preprocess
visitors_by_state = rawdata2 %>% filter(Indicator == "Visitor arrivals", Destination == "Statewide")
names(visitors_by_state)[names(visitors_by_state) == 'Market'] = "NAME"

library(tigris)
# The US map used here is in package tigris. Year = 2019. 
state = states( year = 2019) %>%shift_geometry(position = "outside")

visitors_by_state$NAME[!visitors_by_state$NAME %in% state$NAME]
state$NAME[!state$NAME%in% visitors_by_state$NAME]

#Correct different naming in the key for the join process
visitors_by_state[,"NAME"][visitors_by_state[,"NAME"] == "N. Carolina"] <- "North Carolina"
visitors_by_state[,"NAME"][visitors_by_state[,"NAME"] == "N. Dakota"] <- "North Dakota"
visitors_by_state[,"NAME"][visitors_by_state[,"NAME"] == "S. Carolina"] <- "South Carolina"
visitors_by_state[,"NAME"][visitors_by_state[,"NAME"] == "Washington, D.C."] <- "District of Columbia"
visitors_by_state[,"NAME"][visitors_by_state[,"NAME"] == "S. Dakota"] <- "South Dakota"
visitors_by_state[,"NAME"][visitors_by_state[,"NAME"] == "W. Virginia"] <- "West Virginia"

```


```{r}
# 2019 census-us-population-data-by-state
#https://www.kaggle.com/datasets/peretzcohen/2019-census-us-population-data-by-state?resource=download

state_population_raw = read.csv("data/raw/2019_Census_US_Population_Data_By_State_Lat_Long.csv")
```

```{r}
state_population = state_population_raw[,1:2]
names(state_population)[names(state_population) == 'STATE'] = "NAME"
```

```{r, include=FALSE}
state2 =state %>% filter(NAME %in% visitors_by_state$NAME)
visitors_by_state2 = left_join(state2,visitors_by_state)
visitors_by_state2$X2019 = as.numeric(gsub(",","",visitors_by_state2$X2019))


visitors_by_state3 = left_join(visitors_by_state2, state_population) %>%
  mutate(hawaii_travel_rate = X2019/POPESTIMATE2019)
```

```{r, include=FALSE}
library(sf)
library(tmap)
state2 =state %>% filter(NAME %in% visitors_by_state$NAME)
visitors_by_state2 = left_join(state2,visitors_by_state)
visitors_by_state2$X2019 = as.numeric(gsub(",","",visitors_by_state2$X2019))

mainstate <-st_bbox(state %>% filter(NAME %in% visitors_by_state$NAME))
```

```{r, warning = FALSE}
tm_shape(visitors_by_state3, bbox = mainstate) +
  tm_polygons("hawaii_travel_rate", palette = "Reds",breaks = seq(0,.14,.01)) +
   tm_text("STUSPS", size = .5,remove.overlap =  T)+
    tm_layout(main.title = "2019 Hawaii Travel Rate of States",  main.title.position = c("center","top"))
```

The map clearly shows the number of Hawaii visitors coming from different states over the states' census population in 2019. By looking at the darkness of the red color, we can find Alaska had the highest Hawaii travel rate in 2019, which is far higher than that of the other states. And there is a rough rule: north and west states tend to have higher Hawaii travel rate. This follows our common sense that people living closer to the destination or living under a colder temperature may have a higher willing to take a holiday in Hawaii. 

**2. Why do people come here**

Secondly, we are curious about the reason why people come to Hawaii:
```{r}
purpose<- cbind(d4.1[,c(1)], d4.1[c(grep("Purpose",colnames(d4.1)))])%>%
  pivot_longer(c(2:16), 
               names_to ="Purpose", 
               values_to = "percentage") %>%
  mutate(Purpose = substr(Purpose, 10, 1000)) %>%
  mutate(Purpose = gsub('.{4}$', '', Purpose)) %>%
  filter(Purpose %in% c("Vacation", "Honeymoon/Get married", "Visit Friends/Relative")) %>%
  pivot_wider(names_from = Purpose, 
              values_from = percentage) %>%
  mutate(OtherPurpose = 100 - Vacation - `Honeymoon/Get married` - `Visit Friends/Relative`) %>%
  pivot_longer(c(2:5),
               names_to = "Purpose",
               values_to = "percentage")

purpose %>%
  ggplot(aes(x = Group, y = percentage, fill = Purpose)) +
  geom_col()  +
  theme(axis.text.x = element_text(angle = 10, vjust = 0.5, hjust=1)) +
  labs(title = "Purpose of people going to different islands",
       x = "Destination",
       y = "Percentage")
```


There are 4 major reasons for people to go to Hawaii islands: for vacation, to visit friends or relatives, for honeymoon or get married and for other purposes. From the plot we can see that most people go to Hawaii for vacation. The second major reason is that people go there to visit friends and relatives. Among the 6 islands, Molokai island has the most visitors who go there to visit friends and relatives, while Maui island has the least. The number of people that go to Oahu for honeymoon or get married is the most comparing to other islands.


**3. Where do people live during their visit?**

Accommodation is also pretty important when we plan a trip. Should we rent a cabin, or should we live in a hotel? The accommodations that most people choose could be a safer choice for us.

```{r}
Accom<- cbind(d4.1[,c(1)], d4.1[c(grep("Accom",colnames(d4.1)))]) %>%
  pivot_longer(c(2:14), 
               names_to ="Accommodation", 
               values_to = "percentage") %>%
  mutate(Accommodation = substr(Accommodation, 8, 1000)) %>%
  mutate(Accommodation = gsub('.{4}$', '', Accommodation)) %>%
  filter(Accommodation %in% c("Hotel only", "Condo", "Friends/Relatives", "Rental house")) %>%
  pivot_wider(names_from = Accommodation, 
              values_from = percentage) %>%
  mutate(OtherAccommodation = 100 - `Hotel only` - `Condo` - `Friends/Relatives` - `Rental house`) %>%
  pivot_longer(c(2:6),
               names_to = "Accommodation",
               values_to = "percentage")

Accom %>%
  ggplot(aes(x = Group, y = percentage, fill = Accommodation)) +
  geom_col() +
    theme(axis.text.x = element_text(angle = 10, vjust = 0.5, hjust=1))+
  labs(title = "Accommodation of people going to different islands",
       x = "Destination",
       y = "Percentage")
```

From the stacked barchart we can see that the most popular accommodation is hotel and condos are pretty welcome too. Accommodation choices vary from island to island. For Oahu island, the percentage of people who live in hotel outperforms all the other islands, and for Maui island the number of people living in Condos outperforms other islands. 


**4. Which island is more popular?**

Now we would like to decide which island we would like to go if our travel time is limit by plotting the number of visitors and the length of them to stay in different islands.

```{r}
library(treemap)

d3<- tibble(data3[,-c(5:29)][,c(1,2,3,4,9)])
colnames(d3)[5] <- 'Year_2019'
d3$Year_2019<- as.numeric(gsub(",","", d3$Year_2019))

 d3 %>%
  filter(Indicator == "Visitor arrivals") %>%
  select( -c(Market, Units)) %>%
  treemap::treemap(index=c("Destination"),
                   vSize="Year_2019",
                   vColor="Year_2019",
                   type="value",
                   title="Number of visitors to different islands",  
                   format.legend = list(scientific = FALSE, big.mark = " ")) 
  
 d3 %>%
  filter(Indicator == "Length of stay") %>%
  select( -c(Market, Units)) %>%
  treemap::treemap(index=c("Destination"),
                   vSize="Year_2019",
                   vColor="Year_2019",
                   type="value",
                   title="Length of stay for visitors to different islands",  
                   format.legend = list(scientific = FALSE, big.mark = " ")) 
```


From the two tree maps we can see that most people would visit to Oahu island, then Maui island. Kauai and Kona island are the next popular islands, and Hilo is not as popular as the others. Lanai island is the least popular one. But in terms of length of stay, people who visit Maui iland would stay for the longest time which is approximately 8 days, then Oahu, Kauai and Kona islands have similar length of stay of approximately 6 to 7.5 days. People would stay in Molokai, Hilo and Lanai islands for much less time, which is less than 5 days.



**5. Do people from different states have a preference of different destinations?**

Apart from the features above, we are also curious about whether people from different states have a preference in going to different islands. We applied a static parallel coordinates plot to analyse this problem.

```{r fig.width = 10, fig.height = 5}

library(parcoords)  
library(d3r)

colnames(d2.1)[5] <- 'Year_2019'

g<- d2.1 %>%
  filter(Indicator == "Visitor arrivals") %>%
  dplyr::select(Destination, Market, Year_2019) %>%
  pivot_wider(names_from = Destination,
              values_from = Year_2019) 
g1 <- data.frame(t(data.frame(matrix(unlist(g), nrow=length(g), byrow=TRUE))))
colnames(g1)<- names(g)

library(GGally)
ggparcoord(g1, columns = 2:8, scale = "center", alphaLines = .7, splineFactor = 10, groupColumn = 1) +
 # geom_vline(xintercept = 2:7, color = "lightblue") +
  theme(legend.title = element_text(size = 5), legend.text = element_text(size = 5)) +
  labs(title = "Parallel coordinate plot of people from different states going to different destinations",
       x = "Destination")

```


From the plot we can see that there is no outlier in this dataset. However there are some obvious clusters shown in the plot. For example, Maine, New York, New Jersey, Utha and Vergina is clearly a cluster.To gain a better vision of the parallal coordinate plot, we applied an interactive parallel coordinates plot for the same data:

```{r}
interactive<- g1 %>%
  parcoords(  
    rownames = F     #   turn off rownames from the data.frame  
    , brushMode = "1D-axes"  
    , reorderable = T  
    , queue = T  
    , withD3 = TRUE     
  )
interactive
```

From this interactive plot, the clustering pattern is much easier to observe. For example, Now we can see that Texas, Oklahoma, Kansas, Lowa and Connecicut are clearly a cluster as people from these states would all like to go to Kauai and Kona island instead of Oahu and Maui island.

## People in which states like to visit Hawaii?

